# 🔍 数据同步检查清单

## ✅ 核心数据对比（已统一）

| 英雄 | 属性 | cards_data.json | CardDatabase.js | 状态 |
|------|------|-----------------|-----------------|------|
| **朵莉亚** | 攻击 | 330 | 330 | ✅ 已统一 |
| **朵莉亚** | 护甲 | 325 | 325 | ✅ 已统一 |
| **公孙离** | 攻击 | 575 | 575 | ✅ 已统一 |
| **公孙离** | 闪避 | 25% | 25% | ✅ 已统一 |

---

## 📝 skill_ends_turn 字段说明

**已废弃！** 该字段已被行动点机制（每回合3次行动）完全替代。
- 客户端和服务端数据不一致 **不影响游戏逻辑**
- 不需要同步

---

## ⚠️ 朵莉亚被动UI显示问题

### 问题描述
服务器日志显示朵莉亚恢复了50点，但客户端UI可能显示错误信息。

### 修复状态
**代码已修复（commit 79cbdac）：**

```gdscript
// BattleManager.gd Line 1505-1547

# 1. 处理队友治疗
if effect.has("ally_id") and effect.ally_id != null:
    var ally_card = _find_card_by_id(effect.ally_id)
    if ally_card and effect.has("ally_new_health"):
        ally_card.health = effect.ally_new_health
        _update_battle_entity_display(ally_card)  # ✅ 更新UI

# 2. 构建正确的消息
var msg_parts = []
if self_heal > 0:
    msg_parts.append("自己+%d" % self_heal)
if overflow_shield > 0:
    msg_parts.append("护盾+%d" % overflow_shield)
if ally_heal > 0 and ally_name != "":
    msg_parts.append("%s+%d" % [ally_name, ally_heal])  # ✅ 显示队友治疗

if msg_parts.size() > 0:
    message = ", ".join(msg_parts)
else:
    message = "无效果"  # ✅ 不再显示"生命值已满"
```

### 服务器端数据（确认正确）
```javascript
// server.js Line 686-695
effect: {
  self_heal: actualHeal,           // 朵莉亚恢复量
  overflow_shield: overflowShield, // 溢出护盾
  ally_id: lowestHpAlly?.id,       // 队友ID
  ally_name: lowestHpAlly?.card_name, // 队友名称
  ally_heal: allyHealAmount,       // ✅ 队友实际恢复量
  new_health: card.health,         // 朵莉亚新生命
  ally_new_health: lowestHpAlly?.health // ✅ 队友新生命
}
```

---

## 🎯 检查步骤

### 1. 确认本地代码版本
```bash
cd f:/QQ/Downloads/hok_card
git log -1 --oneline
```

**应该显示：**
```
79cbdac fix: 修复金币系统和朵莉亚UI显示bug
或
5590333 fix: 同步服务器端卡牌数据到最新平衡调整
```

### 2. 拉取最新代码（如果不是最新）
```bash
git pull gitee main
```

### 3. 重启服务器
```bash
cd server
# 停止旧进程（Ctrl+C）
node server.js
```

### 4. 重启Godot编辑器
- 完全关闭Godot
- 重新打开项目
- 清除并重新运行游戏

---

## 📊 预期测试结果

### 服务器日志应显示：
```
[游戏初始化]
  公孙离(600/600, ATK:575)  ✅ 不是600
  朵莉亚(900/900, ATK:330)  ✅ 不是300

⭐ [朵莉亚被动-欢歌] 回合开始恢复
   朵莉亚自己: 660 → 710 (+50)
   队友孙尚香: 305 → 355 (+50)
```

### 客户端UI应显示：
```
朵莉亚的被动技能「欢歌」发动：
自己+50, 孙尚香+50  ✅ 正确！

或（如果朵莉亚满血且无队友需要治疗）：
无效果  ✅ 不再显示"生命值已满"
```

### 客户端卡牌面板：
- 公孙离：⚔️575（不是600）
- 朵莉亚：⚔️330 🛡️325

---

## 🚨 如果仍有问题

### 清除Godot缓存
1. 关闭Godot
2. 删除 `.godot/` 文件夹
3. 重新打开项目

### 检查客户端BattleManager.gd
确认 Line 1505-1547 的代码与上述修复一致。

### 服务器端调试
观察服务器日志中 `ally_heal` 的值：
- 如果是0：说明队友满血，正常
- 如果是50：说明恢复成功，检查客户端是否接收到

---

## 📌 总结

**数据已统一：** 公孙离575攻击25%闪避，朵莉亚330攻击325护甲  
**代码已修复：** 朵莉亚被动UI显示逻辑已完善  
**待验证：** 需要拉取最新代码并重启服务器+Godot才能生效
