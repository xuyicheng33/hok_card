# 行动点系统测试指南

## 🔧 服务器更新步骤

```bash
# 1. SSH连接服务器
ssh root@你的服务器IP

# 2. 进入项目目录
cd ~/hok_card_server

# 3. 拉取最新代码
git reset --hard origin/main

# 4. 查看版本（应该是 2966334）
git log --oneline -1

# 5. 重启服务器
pm2 restart hok-card-server

# 6. 查看日志
pm2 logs hok-card-server --lines 20
```

---

## 🎮 客户端测试步骤

### 1. 重新运行游戏
- 在Godot中按 **F5**
- 或点击右上角的播放按钮

### 2. 进入在线对战
- 选择 "2v2对战"
- 创建房间或加入房间

### 3. 测试场景

#### 场景A：单一操作类型
```
测试1：连续攻击
- 攻击1 → 观察UI → 应显示"行动剩余: 2/3"
- 攻击2 → 观察UI → 应显示"行动剩余: 1/3"
- 攻击3 → 观察UI → 应显示"行动剩余: 0/3"
- 攻击4 → 应被拒绝

测试2：连续技能
- 技能1 → 观察UI → 应显示"行动剩余: 2/3"
- 技能2 → 观察UI → 应显示"行动剩余: 1/3"
- 技能3 → 应被拒绝（技能点不足）
```

#### 场景B：混合操作
```
- 攻击 → "行动剩余: 2/3"
- 技能 → "行动剩余: 1/3" ← 关键测试点
- 攻击 → "行动剩余: 0/3"
- 第4次 → 被拒绝
```

#### 场景C：回合切换
```
- 用完3次行动
- 点击"结束回合"
- 观察UI → 应显示"行动剩余: 3/3"（重置）
```

---

## 📊 Godot控制台关键日志

### 应该看到的日志：

#### 攻击操作
```
🎯 玩家使用行动：1/3
🎯 [UI更新] 行动点变化: 玩家已用 1/3 (剩余2), 敌人已用 0/3 (剩余3)
  → 玩家标签更新: "行动剩余: 3/3" → "行动剩余: 2/3"
收到服务器操作: attack (来自: player_xxx, 是否自己: true)
🎯 自己的操作，不同步行动点（本地已更新）
```

#### 技能操作
```
🎯 玩家使用行动：2/3
🎯 [UI更新] 行动点变化: 玩家已用 2/3 (剩余1), 敌人已用 0/3 (剩余3)
  → 玩家标签更新: "行动剩余: 2/3" → "行动剩余: 1/3"
收到服务器操作: skill (来自: player_xxx, 是否自己: true)
🎯 自己的操作，不同步行动点（本地已更新）
```

### 异常日志：

#### ❌ 如果看到"是否自己: false"（错误）
```
收到服务器操作: skill (来自: player_xxx, 是否自己: false)  ← 错误！
🎯 对方操作，同步行动点: 我方2/3, 敌方0/3
  → 玩家标签更新: "行动剩余: 1/3" → "行动剩余: 1/3"  ← 可能闪烁
```
**说明：服务器字段名仍然错误，需要重新更新服务器**

#### ⚠️ 如果看到标签无效
```
⚠️ 玩家行动点标签无效！
```
**说明：UI初始化失败，需要检查场景结构**

---

## 🐛 常见问题诊断

### 问题1：技能后UI闪回3
**症状：** 技能后UI显示"行动剩余: 3/3"或其他错误值

**日志检查：**
```
收到服务器操作: skill (来自: xxx, 是否自己: ?)
```

**如果"是否自己: false"** → 服务器未更新
- 解决：重新执行服务器更新步骤
- 确认版本：`git log --oneline -1` 应该是 **2966334**

**如果"是否自己: true"** → 客户端同步逻辑问题
- 检查：是否有多次UI更新日志
- 提供完整的控制台日志

### 问题2：UI完全不显示
**症状：** 看不到"行动剩余: X/3"标签

**日志检查：**
```
🎯 [UI更新] 行动点变化: ...
```

**如果没有这个日志** → 信号未发送或未连接
- 重启游戏（F5）
- 查看是否有"⚠️ 标签无效"警告

**如果有日志但UI不显示** → 标签被遮挡或位置错误
- 调整窗口大小
- 查看右上角区域

### 问题3：UI显示固定不变
**症状：** UI始终显示"行动剩余: 3/3"

**日志检查：**
```
  → 玩家标签更新: "xxx" → "xxx"
```

**如果标签没有更新** → 计算错误或信号未触发
- 检查是否有"[UI更新]"日志
- 提供完整日志

---

## 📝 反馈模板

如果测试后仍有问题，请提供：

### 1. 服务器信息
```
git log --oneline -1
# 输出：2966334 fix: 修复技能释放后UI闪回bug
```

### 2. 测试场景
```
操作：攻击 → 技能 → 攻击
```

### 3. Godot控制台日志
```
（复制所有相关日志）
```

### 4. UI显示情况
```
预期：行动剩余 3→2→1→0
实际：行动剩余 3→2→3→2（闪回）
```

### 5. 截图
- UI右上角的行动点显示

---

## ✅ 成功标志

所有以下测试通过：

- [ ] 攻击后UI正确减少（3→2→1→0）
- [ ] 技能后UI正确减少（3→2→1→0）
- [ ] 混合操作UI正确（3→2→1→0）
- [ ] UI不会闪回或跳变
- [ ] 控制台显示"是否自己: true"
- [ ] 控制台显示"不同步行动点"
- [ ] 第4次操作被服务器拒绝
- [ ] 回合切换正确重置为3

**如果所有测试通过，系统完美运行！** 🎉
