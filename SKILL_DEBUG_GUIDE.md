# 技能系统调试指南

## 🐛 **已修复的问题**

### **1. 澜技能攻击力不生效**
**原因：** BattleScene直接调用SkillManager，绕过了BattleManager的在线模式逻辑
**修复：** 修改BattleScene.gd，改为调用BattleManager.execute_skill

### **2. 技能效果不同步**
**原因：** 同上，没有走在线模式流程
**修复：** 确保在线模式下技能请求发送到服务器，结果由服务器广播

### **3. 服务器日志不够详细**
**原因：** 缺少详细的技能效果播报
**修复：** 增强SkillCalculator.js日志输出

---

## 🔄 **更新部署**

### **1. 服务器端更新**

```bash
# SSH连接服务器
ssh root@121.199.78.133

# 停止服务
pkill -f "node server.js"

# 进入目录并拉取代码
cd /root/hok_card
git pull origin main

# 重新启动
nohup npm start > server.log 2>&1 &

# 查看日志
tail -f server.log
```

### **2. 客户端更新**

在Godot中：
1. 项目 → 导出 → Web (HTML5)
2. 导出所有资源
3. 上传到服务器或测试

---

## 📊 **服务器日志示例**

### **朵莉亚治疗**
```
✅ [朵莉亚-人鱼之赐] 朵莉亚 治疗 公孙离
   治疗量: 130 (470 → 600/600)
```

### **澜攻击力提升**
```
✅ [澜-鲨之猎刃] 澜 攻击力提升
   攻击力: 400 → 500 (+100)
   📊 服务器端卡牌状态: 澜 ATK:500
```

### **公孙离暴击率提升**
```
✅ [公孙离-晚云落] 公孙离 暴击属性提升
   暴击率: 20.0% → 60.0%
   暴击效果: 130.0% → 130.0%
   📊 服务器端卡牌状态: 公孙离 暴击60.0% 效果130.0%
```

### **公孙离暴击率溢出转换**
```
✅ [公孙离-晚云落] 公孙离 暴击属性提升
   暴击率: 80.0% → 100.0%
   暴击效果: 130.0% → 140.0%
   溢出转换: 20.0% → 10.0% 暴击效果
   📊 服务器端卡牌状态: 公孙离 暴击100.0% 效果140.0%
```

---

## 🧪 **测试流程**

### **测试1：澜技能攻击力**

1. 创建房间，加入房间（双方）
2. 查看澜的初始攻击力：400
3. 使用技能"鲨之猎刃"（消耗2技能点）
4. **服务器日志应显示：**
   ```
   ✅ [澜-鲨之猎刃] 澜 攻击力提升
      攻击力: 400 → 500 (+100)
      📊 服务器端卡牌状态: 澜 ATK:500
   ```
5. **双方客户端应显示：** 澜攻击力 500
6. **攻击敌人验证：** 伤害应基于500攻击力计算

**验证伤害计算：**
- 假设敌人护甲200
- 原伤害：max(0, 400-200) = 200
- 新伤害：max(0, 500-200) = 300
- **服务器日志应显示300左右的伤害**

---

### **测试2：朵莉亚治疗**

1. 让公孙离受到伤害（血量降低）
2. 朵莉亚使用"人鱼之赐"治疗公孙离
3. **服务器日志应显示：**
   ```
   ✅ [朵莉亚-人鱼之赐] 朵莉亚 治疗 公孙离
      治疗量: 130 (470 → 600/600)
   ```
4. **双方客户端应同步显示：** 公孙离血量增加

---

### **测试3：公孙离暴击率**

1. 查看公孙离初始暴击率：20%
2. 使用"晚云落"技能
3. **服务器日志应显示：**
   ```
   ✅ [公孙离-晚云落] 公孙离 暴击属性提升
      暴击率: 20.0% → 60.0%
   ```
4. **双方客户端应显示：** 暴击率60%
5. **攻击敌人验证：** 暴击概率明显提升

---

## 🔍 **问题排查**

### **如果攻击力依然不生效**

**检查1：客户端是否使用最新版本**
- 重新导出Godot项目
- 清除浏览器缓存

**检查2：服务器日志**
```bash
tail -f /root/hok_card/server.log
```
应该看到：
- `✅ [澜-鲨之猎刃]` 技能执行
- `📊 服务器端卡牌状态: 澜 ATK:500` 属性更新
- `[战斗计算] 澜 -> 目标: XXX伤害` 伤害计算使用新攻击力

**检查3：客户端日志**
打开浏览器控制台（F12），应该看到：
- `🌐 在线模式：技能请求已发送到服务器`
- `🌐 处理技能结果: {"success":true,"effect_type":"attack_buff"...}`
- `🌐 应用攻击增强: 澜 攻击力 → 500`

---

## 📈 **完整技能效果追踪**

### **技能流程：**
```
客户端A（施法者）
   ↓
1. 点击技能按钮
   ↓
2. BattleScene.execute_skill()
   ↓
3. BattleManager.execute_skill() → 检查在线模式
   ↓
4. NetworkManager.send_skill() → 发送到服务器
   ↓
5. 客户端日志：🌐 在线模式：技能请求已发送到服务器

---

服务器
   ↓
6. 收到skill消息
   ↓
7. BattleEngine.calculateSkill()
   ↓
8. SkillCalculator.executeSkill() → 调用具体技能
   ↓
9. 服务器日志：✅ [澜-鲨之猎刃] ...
   ↓
10. 广播结果给双方客户端

---

客户端A和客户端B（双方）
   ↓
11. 收到opponent_action消息
   ↓
12. BattleManager._handle_opponent_skill()
   ↓
13. 根据effect_type调用_apply_xxx_result()
   ↓
14. 更新卡牌属性：caster.attack = new_attack
   ↓
15. 更新UI显示：_update_all_entities_display()
   ↓
16. 客户端日志：🌐 应用攻击增强: 澜 攻击力 → 500
```

---

## 🎯 **关键验证点**

| 阶段 | 日志关键词 | 位置 | 预期内容 |
|------|-----------|------|----------|
| 客户端发送 | `🌐 在线模式：技能请求已发送` | 浏览器F12 | 包含技能名 |
| 服务器接收 | `[技能请求]` | 服务器日志 | caster_id, skill_name |
| 服务器计算 | `✅ [英雄-技能名]` | 服务器日志 | 详细属性变化 |
| 服务器广播 | `[技能成功]` | 服务器日志 | effect_type |
| 客户端接收 | `🌐 处理技能结果` | 浏览器F12 | JSON完整数据 |
| 客户端应用 | `🌐 应用xxx` | 浏览器F12 | 具体属性值 |
| 攻击验证 | `[战斗计算]` | 服务器日志 | 使用新属性计算伤害 |

---

**创建时间：** 2025-01-23  
**版本：** v1.1
