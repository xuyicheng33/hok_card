# 在线对战测试指南

## 🎮 测试环境准备

### 服务器端
1. 启动服务器
```bash
cd server
node server.js
```
服务器应该显示：`WebSocket服务器运行在 ws://localhost:3000`

### 客户端
1. 打开Godot项目
2. 运行项目（F5）
3. 在主菜单选择"在线对战"

---

## ✅ 完整测试流程

### 阶段1：连接和房间创建
- [ ] 玩家1：创建房间
  - 观察：显示房间ID
  - 观察：等待对手加入
- [ ] 玩家2：输入房间ID并加入
  - 观察：双方都显示"对手已加入"
  - 观察：自动开始游戏

### 阶段2：初始状态验证
- [ ] 房主视角（蓝方）
  - 我方：公孙离（600/600 HP） + 澜（700/700 HP）
  - 对方：朵莉亚（900/900 HP） + 澜（700/700 HP）
  - 技能点：我方4点，对方4点
  - 回合：第1回合，我的回合
  
- [ ] 客户端视角（红方）
  - 我方：朵莉亚（900/900 HP） + 澜（700/700 HP）
  - 对方：公孙离（600/600 HP） + 澜（700/700 HP）
  - 技能点：我方4点，对方4点
  - 回合：第1回合，对方回合

### 阶段3：攻击测试
- [ ] 房主：公孙离攻击朵莉亚
  - 观察：伤害计算正确（攻击力 - 护甲）
  - 观察：双方UI同步更新
  - 观察：可能触发暴击（20%概率）
  - 观察：消息日志正确

- [ ] 客户端：观察攻击结果
  - 观察：朵莉亚生命值减少
  - 观察：没有本地重新计算

### 阶段4：技能测试

#### 4.1 朵莉亚主动技能（治疗）
- [ ] 客户端（第2回合）：朵莉亚使用"人鱼之赐"治疗澜
  - 技能消耗：1点（4→3点）
  - 观察：澜恢复130点生命
  - 观察：双方技能点同步
  - 观察：**回合不切换**（重要！）

#### 4.2 澜主动技能（攻击增强）
- [ ] 房主（第3回合）：澜使用"鲨之猎刃"
  - 技能点：5点（第3回合+1）
  - 技能消耗：2点（5→3点）
  - 观察：澜攻击力+100
  - 观察：UI显示新攻击力
  - 观察：下次攻击伤害提升

#### 4.3 公孙离主动技能（暴击率增强）
- [ ] 房主：公孙离使用"晚云落"
  - 技能消耗：3点
  - 观察：暴击率+40%（20%→60%或更高）
  - 观察：如果暴击率>100%，溢出部分转为暴击效果
  - 观察：UI更新

### 阶段5：被动技能测试

#### 5.1 朵莉亚被动（回合恢复）
- [ ] 客户端：结束回合
- [ ] 房主（第4回合）：观察
  - 观察：对方回合开始
  - 观察：客户端技能点+1（4→5）
- [ ] 客户端（第5回合开始）：观察
  - 观察：朵莉亚自动恢复75点生命
  - 观察：如果生命满，溢出转为护盾
  - 观察：消息显示"朵莉亚触发被动：欢歌"

#### 5.2 澜被动（残血增伤）
- [ ] 先将目标打至半血以下
- [ ] 房主：澜攻击残血目标
  - 观察：伤害增加30%
  - 观察：消息显示"澜被动：狩猎触发"

#### 5.3 公孙离被动1（闪避）
- [ ] 客户端：攻击公孙离
  - 观察：30%概率闪避
  - 观察：闪避成功时，公孙离攻击力+10，暴击率+5%
  - 观察：消息显示"公孙离闪避成功"

#### 5.4 公孙离被动2（暴击增加闪避）
- [ ] 房主：公孙离攻击（确保有较高暴击率）
  - 观察：暴击成功时，闪避率+5%（最多+20%）
  - 观察：多次暴击后，闪避率可达50%

### 阶段6：护盾机制测试
- [ ] 朵莉亚生命值满时恢复
  - 观察：溢出的75点转为护盾
  - 观察：护盾值显示
  
- [ ] 对有护盾的目标攻击
  - 观察：护盾先减少
  - 观察：护盾耗尽后才扣生命值
  - 观察：伤害计算正确

### 阶段7：死亡和战斗结束
- [ ] 将一个卡牌打至0生命
  - 观察：卡牌死亡动画
  - 观察：从战场移除
  - 观察：消息显示"XXX被击败"
  
- [ ] 消灭对方所有卡牌
  - 观察：显示"胜利"或"失败"
  - 观察：返回主菜单选项

---

## 🐛 常见问题排查

### 问题1：连接失败
- 检查服务器是否启动
- 检查端口3000是否被占用
- 检查防火墙设置

### 问题2：技能点不同步
- 应该看到"收到技能点更新"日志
- 不应该触发回合切换
- 技能点应该在双方一致

### 问题3：攻击伤害不一致
- 检查是否显示"应用服务器攻击结果"
- 不应该有本地重新计算
- 暴击/闪避判定应该一致

### 问题4：护盾不生效
- 检查是否显示"护盾吸收X伤害"
- 护盾应该在服务器端计算
- 护盾值应该同步

### 问题5：UI不更新
- 检查是否调用_update_battle_entity_display
- 检查卡牌实体是否存在
- 检查信号连接

---

## 📊 日志关键词

### 服务器端
```
✅ [朵莉亚-人鱼之赐] - 治疗成功
✅ [澜-鲨之猎刃] - 攻击力提升
✅ [公孙离-晚云落] - 暴击属性提升
⚔️  [攻击计算] - 攻击流程
💥 基础伤害 = - 伤害计算
⭐ 澜被动「狩猎」触发 - 残血增伤
💨 公孙离闪避 - 闪避成功
💢 暴击 - 暴击触发
🛡️ 护盾吸收 - 护盾机制
⭐ [朵莉亚被动-欢歌] - 回合恢复
```

### 客户端
```
🎯 服务器回合变化 - 回合切换
🎯 服务器技能点同步 - 技能点更新
🎮 服务器攻击结果 - 攻击同步
🌐 处理技能结果 - 技能同步
⭐ [被动技能] - 被动触发
🎯 更新公孙离闪避 - 闪避率同步
✅ 技能点更新完成（不切换回合） - 重要！
```

---

## ✅ 测试通过标准

### 功能完整性
- [ ] 所有8个英雄的技能正常
- [ ] 所有被动技能触发正确
- [ ] 护盾机制工作正常
- [ ] 死亡和战斗结束正常

### 数据同步
- [ ] 攻击结果双方一致
- [ ] 技能效果双方一致
- [ ] 技能点双方一致
- [ ] 回合数双方一致
- [ ] 卡牌状态双方一致

### 用户体验
- [ ] UI实时更新
- [ ] 消息提示清晰
- [ ] 没有明显延迟
- [ ] 错误提示友好

### 健壮性
- [ ] 断线能正确处理
- [ ] 错误操作有提示
- [ ] 无法进行非法操作
- [ ] 没有崩溃

---

## 🎯 性能测试

### 延迟测试
- 本地测试：< 50ms
- 同城测试：< 100ms
- 异地测试：< 300ms

### 稳定性测试
- 连续对战10局无崩溃
- 长时间挂机不断线
- 快速操作不出错

---

## 📝 测试报告模板

```
测试时间：____年__月__日
测试人员：________
服务器版本：______
客户端版本：______

【基础功能】
- 连接建立：□通过 □失败
- 房间创建：□通过 □失败
- 游戏开始：□通过 □失败

【核心功能】
- 攻击同步：□通过 □失败
- 技能同步：□通过 □失败
- 被动技能：□通过 □失败
- 护盾机制：□通过 □失败
- 技能点管理：□通过 □失败

【发现问题】
1. ______________________
2. ______________________
3. ______________________

【总体评价】
□ 可以正式发布
□ 需要修复问题
□ 需要重大改进
```
