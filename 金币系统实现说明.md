# 💰 金币系统实现说明 v1.0

## ✅ 已完成功能

### 1. 服务器端（完整实现）

#### **初始化**
- 双方初始金币：**10金币**
- 位置：`server.js` Line 88-89

#### **金币计算函数**
```javascript
calculateGoldIncome(currentGold)
- 基础收入：+5金币/回合
- 利息：当前金币 × 10%（向下取整）
- 利息上限：最多+5金币/回合
- 返回：{base, interest, total, newGold}
```
位置：`server.js` Line 47-61

#### **回合结算**
- **时机**：回合结束时结算，下回合开始时可用
- **流程**：
  1. 计算当前回合结束玩家的金币收入
  2. 更新该玩家的金币总额
  3. 打印金币结算日志
- 位置：`server.js` Line 678-696

#### **网络同步**
- **game_start消息**：包含初始金币（host_gold, guest_gold）
- **turn_changed消息**：包含双方当前金币和收入详情
  - host_gold：房主金币
  - guest_gold：客户端金币
  - gold_income：收入详情{base, interest, total, newGold}

---

### 2. 客户端（基础框架）

#### **变量定义**
```gdscript
var player_gold: int = 10  # 玩家金币
var enemy_gold: int = 10   # 敌人金币
```
位置：`BattleManager.gd` Line 49-50

#### **信号定义**
```gdscript
signal gold_changed(player_gold: int, enemy_gold: int, income_data: Dictionary)
```
位置：`BattleManager.gd` Line 71

#### **服务器同步**
- 在`_on_server_turn_changed()`中接收金币数据
- 自动区分房主/客户端视角
- 打印金币同步日志
- 发出gold_changed信号
位置：`BattleManager.gd` Line 1034-1058

---

## 📊 金币增长曲线

| 回合 | 基础收入 | 利息 | 回合收入 | 累计金币 |
|-----|---------|-----|---------|---------|
| 开始 | - | - | 0 | **10** |
| 1 | +5 | +1 | +6 | 16 |
| 2 | +5 | +1 | +6 | 22 |
| 3 | +5 | +2 | +7 | 29 |
| 4 | +5 | +2 | +7 | 36 |
| 5 | +5 | +3 | +8 | 44 |
| 6 | +5 | +4 | +9 | 53 |
| 7 | +5 | +5 | +10 | 63 |
| 8 | +5 | +5 | +10 | 73 |
| 10 | +5 | +5 | +10 | 93 |

**注意**：利息上限为5金币，所以50+金币后每回合固定+10

---

## 🔧 服务器日志示例

```
💰 [金币结算] 房主/蓝方
   当前金币: 10 → 16
   基础收入: +5, 利息: +1 (总收入: +6)
───────────────────────────────────────────────────────
   技能点: 房主 5/6 | 客户端 4/6
   金币: 房主 💰16 | 客户端 💰10
```

---

## 🖥️ 客户端日志示例

```
🎯 服务器技能点同步: 我方5, 敌方4
💰 服务器金币同步: 我方💰16, 敌方💰10
   本次收入: 基础+5, 利息+1, 总计+6
```

---

## 📝 实现时间线示例

```
游戏开始
├─ 双方初始金币：10
│
第1回合（房主）
├─ 回合开始：房主可用金币 = 10
├─ 房主操作：攻击/技能...
├─ 回合结束：
│   └─ 💰 金币结算：10 + 5基础 + 1利息 = 16
│   └─ 广播："房主下回合将有16金币"
│
第2回合（客户端）
├─ 回合开始：客户端可用金币 = 10（初始）
├─ 客户端操作...
├─ 回合结束：
│   └─ 💰 金币结算：10 + 5 + 1 = 16
│
第3回合（房主）
├─ 回合开始：房主可用金币 = 16 ← 第1回合结算的
├─ 房主操作...
├─ 回合结束：
│   └─ 💰 金币结算：16 + 5 + 1 = 22
```

---

## 🚧 待实现功能

### 1. UI显示（高优先级）
- [ ] 金币数值显示标签
- [ ] 金币变化动画
- [ ] 收入提示弹窗

### 2. 消费功能（中优先级）
- [ ] 购买技能点接口（10金币 = 1技能点）
- [ ] 金币扣除逻辑
- [ ] 金额不足提示

### 3. 未来扩展（低优先级）
- [ ] 装备抽取系统
- [ ] 中立资源奖励
- [ ] 任务系统奖励

---

## 🎯 下一步开发建议

1. **先做UI显示**（1-2小时）
   - 在BattleScene.gd中连接gold_changed信号
   - 创建金币显示UI（左上角）
   - 添加简单的数字变化动画

2. **再做消费功能**（1小时）
   - 添加spend_gold()函数
   - 实现"购买技能点"按钮（10金币→1技能点）
   - 测试金币扣除和同步

3. **优化体验**（30分钟）
   - 金币收入提示弹窗
   - 音效和特效
   - 完善UI交互

---

## ✅ 测试检查清单

### 服务器端测试
- [x] 游戏开始时双方金币为10
- [x] 回合结束时正确计算金币
- [x] 利息计算正确（10%，上限5）
- [x] 金币数据正确广播

### 客户端测试
- [x] 接收game_start的金币数据
- [x] 接收turn_changed的金币数据
- [x] 正确区分房主/客户端视角
- [x] 发出gold_changed信号
- [ ] UI显示正确（待实现）

---

## 📦 修改文件清单

1. **server/server.js**
   - 添加calculateGoldIncome()函数
   - initGameState()中添加初始金币
   - end_turn处理中添加金币结算
   - game_start和turn_changed消息中添加金币字段

2. **scripts/core/BattleManager.gd**
   - 添加player_gold和enemy_gold变量
   - 添加gold_changed信号
   - _on_server_turn_changed()中添加金币同步

---

**当前状态：✅ 服务器端完整实现，客户端基础框架完成，可以开始UI开发！**
